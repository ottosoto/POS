(function(e){e.widget("ui.selectmenu",{_init:function(){var t=this,n=this.options;this.ids=[this.element.attr("id")+"-"+"button",this.element.attr("id")+"-"+"menu"];this._safemouseup=true;this.newelement=e('<a class="'+this.widgetBaseClass+' ui-widget ui-state-default ui-corner-all" id="'+this.ids[0]+'" role="button" href="#" aria-haspopup="true" aria-owns="'+this.ids[1]+'"></a>').insertAfter(this.element);var r=this.element.attr("tabindex");if(r){this.newelement.attr("tabindex",r)}this.newelement.data("selectelement",this.element);this.selectmenuIcon=e('<span class="'+this.widgetBaseClass+'-icon ui-icon"></span>').prependTo(this.newelement).addClass(n.style=="popup"?"ui-icon-triangle-2-n-s":"ui-icon-triangle-1-s");e("label[for="+this.element.attr("id")+"]").attr("for",this.ids[0]).bind("click",function(){t.newelement[0].focus();return false});this.newelement.bind("mousedown",function(e){t._toggle(e);if(n.style=="popup"){t._safemouseup=false;setTimeout(function(){t._safemouseup=true},300)}return false}).bind("click",function(){return false}).keydown(function(n){var r=true;switch(n.keyCode){case e.ui.keyCode.ENTER:r=true;break;case e.ui.keyCode.SPACE:r=false;t._toggle(n);break;case e.ui.keyCode.UP:case e.ui.keyCode.LEFT:r=false;t._moveSelection(-1);break;case e.ui.keyCode.DOWN:case e.ui.keyCode.RIGHT:r=false;t._moveSelection(1);break;case e.ui.keyCode.TAB:r=true;break;default:r=false;t._typeAhead(n.keyCode,"mouseup");break}return r}).bind("mouseover focus",function(){e(this).addClass(t.widgetBaseClass+"-focus ui-state-hover")}).bind("mouseout blur",function(){e(this).removeClass(t.widgetBaseClass+"-focus ui-state-hover")});e(document).mousedown(function(e){t.close(e)});this.element.click(function(){this._refreshValue()}).focus(function(){this.newelement[0].focus()});var i=n.style=="dropdown"?" ui-corner-bottom":" ui-corner-all";this.list=e('<ul class="'+t.widgetBaseClass+"-menu ui-widget ui-widget-content"+i+'" aria-hidden="true" role="listbox" aria-labelledby="'+this.ids[0]+'" id="'+this.ids[1]+'"></ul>').appendTo("body");var s=[];this.element.find("option").each(function(){s.push({value:e(this).attr("value"),text:t._formatText(jQuery(this).text()),selected:e(this).attr("selected"),classes:e(this).attr("class"),parentOptGroup:e(this).parent("optgroup").attr("label")})});var o=t.options.style=="popup"?" ui-state-active":"";for(var u in s){var a=e('<li role="presentation"><a href="#" tabindex="-1" role="option" aria-selected="false">'+s[u].text+"</a></li>").data("index",u).addClass(s[u].classes).data("optionClasses",s[u].classes||"").mouseup(function(n){if(t._safemouseup){var r=e(this).data("index")!=t._selectedIndex();t.value(e(this).data("index"));t.select(n);if(r){t.change(n)}t.close(n,true)}return false}).click(function(){return false}).bind("mouseover focus",function(){t._selectedOptionLi().addClass(o);t._focusedOptionLi().removeClass(t.widgetBaseClass+"-item-focus ui-state-hover");e(this).removeClass("ui-state-active").addClass(t.widgetBaseClass+"-item-focus ui-state-hover")}).bind("mouseout blur",function(){if(e(this).is(t._selectedOptionLi())){e(this).addClass(o)}e(this).removeClass(t.widgetBaseClass+"-item-focus ui-state-hover")});if(s[u].parentOptGroup){var f=t.widgetBaseClass+"-group-"+s[u].parentOptGroup;if(this.list.find("li."+f).size()){this.list.find("li."+f+":last ul").append(a)}else{e('<li role="presentation" class="'+t.widgetBaseClass+"-group "+f+'"><span class="'+t.widgetBaseClass+'-group-label">'+s[u].parentOptGroup+"</span><ul></ul></li>").appendTo(this.list).find("ul").append(a)}}else{a.appendTo(this.list)}this.list.bind("mousedown mouseup",function(){return false});if(n.icons){for(var l in n.icons){if(a.is(n.icons[l].find)){a.data("optionClasses",s[u].classes+" "+t.widgetBaseClass+"-hasIcon").addClass(t.widgetBaseClass+"-hasIcon");var c=n.icons[l].icon||"";a.find("a:eq(0)").prepend('<span class="'+t.widgetBaseClass+"-item-icon ui-icon "+c+'"></span>')}}}}this.list.find("li:last").addClass("ui-corner-bottom");if(n.style=="popup"){this.list.find("li:first").addClass("ui-corner-top")}if(n.transferClasses){var h=this.element.attr("class")||"";this.newelement.add(this.list).addClass(h)}var p=this.element.width();this.newelement.width(n.width?n.width:p);if(n.style=="dropdown"){this.list.width(n.menuWidth?n.menuWidth:n.width?n.width:p)}else{this.list.width(n.menuWidth?n.menuWidth:n.width?n.width-n.handleWidth:p-n.handleWidth)}if(n.maxHeight&&n.maxHeight<this.list.height()){this.list.height(n.maxHeight)}this._optionLis=this.list.find("li:not(."+t.widgetBaseClass+"-group)");this.list.keydown(function(n){var r=true;switch(n.keyCode){case e.ui.keyCode.UP:case e.ui.keyCode.LEFT:r=false;t._moveFocus(-1);break;case e.ui.keyCode.DOWN:case e.ui.keyCode.RIGHT:r=false;t._moveFocus(1);break;case e.ui.keyCode.HOME:r=false;t._moveFocus(":first");break;case e.ui.keyCode.PAGE_UP:r=false;t._scrollPage("up");break;case e.ui.keyCode.PAGE_DOWN:r=false;t._scrollPage("down");break;case e.ui.keyCode.END:r=false;t._moveFocus(":last");break;case e.ui.keyCode.ENTER:case e.ui.keyCode.SPACE:r=false;t.close(n,true);e(n.target).parents("li:eq(0)").trigger("mouseup");break;case e.ui.keyCode.TAB:r=true;t.close(n,true);break;case e.ui.keyCode.ESCAPE:r=false;t.close(n,true);break;default:r=false;t._typeAhead(n.keyCode,"focus");break}return r});if(n.style=="dropdown"){this.newelement.addClass(t.widgetBaseClass+"-dropdown");this.list.addClass(t.widgetBaseClass+"-menu-dropdown")}else{this.newelement.addClass(t.widgetBaseClass+"-popup");this.list.addClass(t.widgetBaseClass+"-menu-popup")}this.newelement.prepend('<span class="'+t.widgetBaseClass+'-status">'+s[this._selectedIndex()].text+"</span>");this.element.hide();if(this.element.attr("disabled")==true){this.disable()}this.value(this._selectedIndex())},destroy:function(){this.element.removeData(this.widgetName).removeClass(this.widgetBaseClass+"-disabled"+" "+this.namespace+"-state-disabled").removeAttr("aria-disabled");e("label[for="+this.newelement.attr("id")+"]").attr("for",this.element.attr("id")).unbind("click");this.newelement.remove();this.list.remove();this.element.show()},_typeAhead:function(t,n){function o(t,i){s=true;e(t).trigger(n);r._prevChar[1]=i}var r=this;if(!r._prevChar){r._prevChar=["",0]}var i=String.fromCharCode(t);c=i.toLowerCase();var s=false;this.list.find("li a").each(function(t){if(!s){var n=e(this).text();if(n.indexOf(i)==0||n.indexOf(c)==0){if(r._prevChar[0]==i){if(r._prevChar[1]<t){o(this,t)}}else{o(this,t)}}}});this._prevChar[0]=i},_uiHash:function(){return{value:this.value()}},open:function(e){var t=this;var n=this.newelement.attr("aria-disabled");if(n!="true"){this._refreshPosition();this._closeOthers(e);this.newelement.addClass("ui-state-active");this.list.appendTo("body").addClass(t.widgetBaseClass+"-open").attr("aria-hidden",false).find("li:not(."+t.widgetBaseClass+"-group):eq("+this._selectedIndex()+") a")[0].focus();if(this.options.style=="dropdown"){this.newelement.removeClass("ui-corner-all").addClass("ui-corner-top")}this._refreshPosition();this._trigger("open",e,this._uiHash())}},close:function(e,t){if(this.newelement.is(".ui-state-active")){this.newelement.removeClass("ui-state-active");this.list.attr("aria-hidden",true).removeClass(this.widgetBaseClass+"-open");if(this.options.style=="dropdown"){this.newelement.removeClass("ui-corner-top").addClass("ui-corner-all")}if(t){this.newelement[0].focus()}this._trigger("close",e,this._uiHash())}},change:function(e){this.element.trigger("change");this._trigger("change",e,this._uiHash())},select:function(e){this._trigger("select",e,this._uiHash())},_closeOthers:function(t){e("."+this.widgetBaseClass+".ui-state-active").not(this.newelement).each(function(){e(this).data("selectelement").selectmenu("close",t)});e("."+this.widgetBaseClass+".ui-state-hover").trigger("mouseout")},_toggle:function(e,t){if(this.list.is("."+this.widgetBaseClass+"-open")){this.close(e,t)}else{this.open(e)}},_formatText:function(e){return this.options.format?this.options.format(e):e},_selectedIndex:function(){return this.element[0].selectedIndex},_selectedOptionLi:function(){return this._optionLis.eq(this._selectedIndex())},_focusedOptionLi:function(){return this.list.find("."+this.widgetBaseClass+"-item-focus")},_moveSelection:function(e){var t=parseInt(this._selectedOptionLi().data("index"),10);var n=t+e;return this._optionLis.eq(n).trigger("mouseup")},_moveFocus:function(e){if(!isNaN(e)){var t=parseInt(this._focusedOptionLi().data("index"),10);var n=t+e}else{var n=parseInt(this._optionLis.filter(e).data("index"),10)}if(n<0){n=0}if(n>this._optionLis.size()-1){n=this._optionLis.size()-1}var r=this.widgetBaseClass+"-item-"+Math.round(Math.random()*1e3);this._focusedOptionLi().find("a:eq(0)").attr("id","");this._optionLis.eq(n).find("a:eq(0)").attr("id",r)[0].focus();this.list.attr("aria-activedescendant",r)},_scrollPage:function(e){var t=Math.floor(this.list.outerHeight()/this.list.find("li:first").outerHeight());t=e=="up"?-t:t;this._moveFocus(t)},_setData:function(e,t){this.options[e]=t;if(e=="disabled"){this.close();this.element.add(this.newelement).add(this.list)[t?"addClass":"removeClass"](this.widgetBaseClass+"-disabled"+" "+this.namespace+"-state-disabled").attr("aria-disabled",t)}},value:function(e){if(arguments.length){this.element[0].selectedIndex=e;this._refreshValue();this._refreshPosition()}return this.element[0].selectedIndex},_refreshValue:function(){var e=this.options.style=="popup"?" ui-state-active":"";var t=this.widgetBaseClass+"-item-"+Math.round(Math.random()*1e3);this.list.find("."+this.widgetBaseClass+"-item-selected").removeClass(this.widgetBaseClass+"-item-selected"+e).find("a").attr("aria-selected","false").attr("id","");this._selectedOptionLi().addClass(this.widgetBaseClass+"-item-selected"+e).find("a").attr("aria-selected","true").attr("id",t);var n=this.newelement.data("optionClasses")?this.newelement.data("optionClasses"):"";var r=this._selectedOptionLi().data("optionClasses")?this._selectedOptionLi().data("optionClasses"):"";this.newelement.removeClass(n).data("optionClasses",r).addClass(r).find("."+this.widgetBaseClass+"-status").html(this._selectedOptionLi().find("a:eq(0)").html());this.list.attr("aria-activedescendant",t)},_refreshPosition:function(){this.list.css("left",this.newelement.offset().left);var t=this.newelement.offset().top;var n=this.list[0].scrollTop;this.list.find("li:lt("+this._selectedIndex()+")").each(function(){n-=e(this).outerHeight()});if(this.newelement.is("."+this.widgetBaseClass+"-popup")){t+=n;this.list.css("top",t)}else{t+=this.newelement.height();this.list.css("top",t)}}});e.extend(e.ui.selectmenu,{getter:"value",version:"@VERSION",eventPrefix:"selectmenu",defaults:{transferClasses:true,style:"popup",width:null,menuWidth:null,handleWidth:26,maxHeight:null,icons:null,format:null}})})(jQuery)